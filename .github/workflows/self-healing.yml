name: ðŸ”„ Self-Healing System (æ°¸å‹•æ©Ÿ)

on:
  # ç•¶å…¶ä»– workflow å¤±æ•—æ™‚è‡ªå‹•è§¸ç™¼
  workflow_run:
    workflows:
      - "ðŸ¤– Fully Auto Generate & Publish"
      - "ðŸš€ Build, Test & Deploy"
    types:
      - completed

  # å®šæœŸå¥åº·æª¢æŸ¥ï¼ˆæ¯å°æ™‚ï¼‰
  schedule:
    - cron: '0 * * * *'

  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      force_fix:
        description: 'å¼·åˆ¶åŸ·è¡Œä¿®å¾©'
        type: boolean
        default: false

env:
  MAX_RETRY: 3
  RETRY_DELAY: 300  # 5 åˆ†é˜

jobs:
  # Job 1: ç³»çµ±å¥åº·æª¢æŸ¥
  health-check:
    name: ðŸ¥ System Health Check
    runs-on: ubuntu-latest
    outputs:
      needs_healing: ${{ steps.check.outputs.needs_healing }}
      failed_workflow: ${{ steps.check.outputs.failed_workflow }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“Š Check system health
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ¥ æª¢æŸ¥ç³»çµ±å¥åº·ç‹€æ…‹..."

          # æª¢æŸ¥æœ€è¿‘çš„ workflow runs
          FAILED_RUNS=$(gh run list --limit 10 --json status,conclusion,name,workflowName | \
            jq '[.[] | select(.conclusion == "failure")] | length')

          echo "failed_runs=$FAILED_RUNS" >> $GITHUB_OUTPUT

          # åˆ¤æ–·æ˜¯å¦éœ€è¦ä¿®å¾©
          if [ "$FAILED_RUNS" -gt 0 ] || [ "${{ github.event.inputs.force_fix }}" = "true" ]; then
            echo "needs_healing=true" >> $GITHUB_OUTPUT

            # æ‰¾å‡ºå¤±æ•—çš„ workflow
            FAILED_WORKFLOW=$(gh run list --limit 1 --json status,conclusion,name,workflowName | \
              jq -r '.[0].workflowName')
            echo "failed_workflow=$FAILED_WORKFLOW" >> $GITHUB_OUTPUT

            echo "âš ï¸ ç³»çµ±éœ€è¦è‡ªæˆ‘ä¿®å¾©ï¼"
            echo "âŒ å¤±æ•—çš„ workflow: $FAILED_WORKFLOW"
          else
            echo "needs_healing=false" >> $GITHUB_OUTPUT
            echo "âœ… ç³»çµ±å¥åº·ï¼Œç„¡éœ€ä¿®å¾©"
          fi

      - name: ðŸ“ˆ Generate health report
        run: |
          echo "## ðŸ¥ ç³»çµ±å¥åº·å ±å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **æª¢æŸ¥æ™‚é–“**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- **å¤±æ•—æ¬¡æ•¸**: ${{ steps.check.outputs.failed_runs }}" >> $GITHUB_STEP_SUMMARY
          echo "- **éœ€è¦ä¿®å¾©**: ${{ steps.check.outputs.needs_healing }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check.outputs.needs_healing }}" = "true" ]; then
            echo "- **å¤±æ•—çš„æµç¨‹**: ${{ steps.check.outputs.failed_workflow }}" >> $GITHUB_STEP_SUMMARY
          fi

  # Job 2: è‡ªå‹•è¨ºæ–·å’Œä¿®å¾©
  auto-fix:
    name: ðŸ”§ Auto Diagnosis & Fix
    needs: health-check
    runs-on: ubuntu-latest
    if: needs.health-check.outputs.needs_healing == 'true'
    outputs:
      fix_applied: ${{ steps.fix.outputs.fix_applied }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ’Ž Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.1
          bundler-cache: true

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install dependencies
        run: |
          pip install -r _tests/requirements.txt
          bundle install

      - name: ðŸ” Diagnose issues
        id: diagnose
        run: |
          echo "ðŸ” è¨ºæ–·ç³»çµ±å•é¡Œ..."

          # é‹è¡Œæ‰€æœ‰æ¸¬è©¦æ‰¾å‡ºå•é¡Œ
          python _tests/auto_fixer.py scan > diagnosis.json || true

          if [ -f diagnosis.json ]; then
            ISSUE_COUNT=$(jq '.total_issues' diagnosis.json 2>/dev/null || echo "0")
            echo "issue_count=$ISSUE_COUNT" >> $GITHUB_OUTPUT

            echo "ðŸ“‹ ç™¼ç¾ $ISSUE_COUNT å€‹å•é¡Œ"
            cat diagnosis.json
          else
            echo "issue_count=0" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ”§ Apply fixes
        id: fix
        if: steps.diagnose.outputs.issue_count > 0
        run: |
          echo "ðŸ”§ è‡ªå‹•ä¿®å¾©å•é¡Œ..."

          # åŸ·è¡Œè‡ªå‹•ä¿®å¾©
          python _tests/auto_fixer.py fix > fix_result.json || true

          FIXED_COUNT=$(jq '.fixed_count' fix_result.json 2>/dev/null || echo "0")
          echo "fixed_count=$FIXED_COUNT" >> $GITHUB_OUTPUT

          if [ "$FIXED_COUNT" -gt 0 ]; then
            echo "fix_applied=true" >> $GITHUB_OUTPUT
            echo "âœ… æˆåŠŸä¿®å¾© $FIXED_COUNT å€‹å•é¡Œ"
          else
            echo "fix_applied=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ ç„¡æ³•è‡ªå‹•ä¿®å¾©"
          fi

      - name: ðŸ§ª Verify fixes
        if: steps.fix.outputs.fix_applied == 'true'
        run: |
          echo "ðŸ§ª é©—è­‰ä¿®å¾©..."

          # é‡æ–°æ§‹å»ºæ¸¬è©¦
          bundle exec jekyll build || exit 1

          # é‹è¡Œæ¸¬è©¦
          python _tests/test_links.py || true
          python _tests/test_content.py || true

          echo "âœ… ä¿®å¾©é©—è­‰å®Œæˆ"

      - name: ðŸ“ Commit fixes
        if: steps.fix.outputs.fix_applied == 'true'
        run: |
          git config user.name "Self-Healing Bot"
          git config user.email "bot@github-actions"

          git add -A

          cat > commit_msg.txt <<EOF
          ðŸ”§ è‡ªå‹•ä¿®å¾©ï¼šä¿®æ­£ ${{ steps.fix.outputs.fixed_count }} å€‹å•é¡Œ

          ç”± Self-Healing System è‡ªå‹•è¨ºæ–·ä¸¦ä¿®å¾©
          è§¸ç™¼åŽŸå› ï¼š${{ needs.health-check.outputs.failed_workflow }} å¤±æ•—

          ä¿®å¾©å…§å®¹ï¼š
          - è‡ªå‹•æŽƒæå•é¡Œ
          - æ‡‰ç”¨ä¿®å¾©æ–¹æ¡ˆ
          - é©—è­‰ä¿®å¾©çµæžœ

          ---
          Run ID: ${{ github.run_id }}
          Timestamp: $(date '+%Y-%m-%d %H:%M:%S')
          EOF

          git commit -F commit_msg.txt || echo "No changes to commit"
          git push origin ${{ github.ref_name }}

  # Job 3: è‡ªå‹•é‡è©¦å¤±æ•—çš„ä»»å‹™
  auto-retry:
    name: ðŸ”„ Auto Retry Failed Tasks
    needs: [health-check, auto-fix]
    runs-on: ubuntu-latest
    if: needs.auto-fix.outputs.fix_applied == 'true'

    steps:
      - name: â³ Wait for changes to propagate
        run: |
          echo "â³ ç­‰å¾… ${{ env.RETRY_DELAY }} ç§’å¾Œé‡è©¦..."
          sleep ${{ env.RETRY_DELAY }}

      - name: ðŸ”„ Retry failed workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FAILED_WORKFLOW="${{ needs.health-check.outputs.failed_workflow }}"

          echo "ðŸ”„ é‡æ–°é‹è¡Œå¤±æ•—çš„ workflow: $FAILED_WORKFLOW"

          # æ ¹æ“šå¤±æ•—çš„ workflow é‡æ–°è§¸ç™¼
          if [[ "$FAILED_WORKFLOW" == *"Auto Generate"* ]]; then
            gh workflow run fully-auto-content.yml
            echo "âœ… å·²é‡æ–°è§¸ç™¼å…§å®¹ç”Ÿæˆæµç¨‹"
          elif [[ "$FAILED_WORKFLOW" == *"Deploy"* ]]; then
            gh workflow run deploy.yml
            echo "âœ… å·²é‡æ–°è§¸ç™¼éƒ¨ç½²æµç¨‹"
          else
            echo "âš ï¸ æœªçŸ¥çš„ workflowï¼Œè·³éŽé‡è©¦"
          fi

  # Job 4: ç›£æŽ§å’Œå ±å‘Š
  monitor-and-report:
    name: ðŸ“Š Monitor & Report
    needs: [health-check, auto-fix, auto-retry]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“Š Generate comprehensive report
        uses: actions/github-script@v7
        with:
          script: |
            const needsHealing = '${{ needs.health-check.outputs.needs_healing }}';
            const fixApplied = '${{ needs.auto-fix.outputs.fix_applied }}';
            const failedWorkflow = '${{ needs.health-check.outputs.failed_workflow }}';
            const healthCheckResult = '${{ needs.health-check.result }}';
            const autoFixResult = '${{ needs.auto-fix.result }}';
            const autoRetryResult = '${{ needs.auto-retry.result }}';

            const now = new Date().toISOString();
            const dateStr = now.split('T')[0];

            let title = '';
            let body = '';
            let labels = ['self-healing', 'automated'];

            if (needsHealing === 'true') {
              if (fixApplied === 'true') {
                title = 'âœ… è‡ªæˆ‘ä¿®å¾©æˆåŠŸ - ' + dateStr;
                labels.push('fixed');

                body = '## âœ… è‡ªæˆ‘ä¿®å¾©æˆåŠŸå ±å‘Š\n\n' +
                  '**æ™‚é–“**: ' + new Date().toLocaleString('zh-TW') + '\n' +
                  '**è§¸ç™¼åŽŸå› **: ' + failedWorkflow + ' å¤±æ•—\n\n' +
                  '### ðŸ”„ ä¿®å¾©æµç¨‹\n\n' +
                  '1. âœ… å¥åº·æª¢æŸ¥ï¼šæª¢æ¸¬åˆ°ç³»çµ±ç•°å¸¸\n' +
                  '2. âœ… è‡ªå‹•è¨ºæ–·ï¼šæ‰¾å‡ºå•é¡Œæ ¹æº\n' +
                  '3. âœ… æ‡‰ç”¨ä¿®å¾©ï¼šè‡ªå‹•ä¿®å¾©å•é¡Œ\n' +
                  '4. âœ… é©—è­‰ä¿®å¾©ï¼šç¢ºèªä¿®å¾©æœ‰æ•ˆ\n' +
                  '5. âœ… è‡ªå‹•é‡è©¦ï¼šé‡æ–°é‹è¡Œå¤±æ•—ä»»å‹™\n\n' +
                  '### ðŸ“Š çµæžœçµ±è¨ˆ\n\n' +
                  '- **å¥åº·æª¢æŸ¥**: ' + healthCheckResult + '\n' +
                  '- **è‡ªå‹•ä¿®å¾©**: ' + autoFixResult + '\n' +
                  '- **è‡ªå‹•é‡è©¦**: ' + autoRetryResult + '\n\n' +
                  '---\n' +
                  'ðŸ¤– ç³»çµ±å·²æ¢å¾©æ­£å¸¸é‹ä½œï¼\n' +
                  '*ç”± Self-Healing System è‡ªå‹•ç”Ÿæˆ*';
              } else {
                title = 'âš ï¸ éœ€è¦äººå·¥ä»‹å…¥ - ' + dateStr;
                labels.push('needs-attention');

                body = '## âš ï¸ è‡ªå‹•ä¿®å¾©å¤±æ•—\n\n' +
                  '**æ™‚é–“**: ' + new Date().toLocaleString('zh-TW') + '\n' +
                  '**å•é¡Œ**: ' + failedWorkflow + ' å¤±æ•—\n\n' +
                  '### âŒ ç„¡æ³•è‡ªå‹•ä¿®å¾©\n\n' +
                  'è‡ªå‹•ä¿®å¾©ç³»çµ±ç„¡æ³•è§£æ±ºæ­¤å•é¡Œï¼Œéœ€è¦äººå·¥ä»‹å…¥ã€‚\n\n' +
                  '### ðŸ” å»ºè­°æª¢æŸ¥\n\n' +
                  '1. æŸ¥çœ‹ workflow é‹è¡Œæ—¥èªŒ\n' +
                  '2. æª¢æŸ¥æœ€è¿‘çš„ä»£ç¢¼è®Šæ›´\n' +
                  '3. é©—è­‰ç³»çµ±é…ç½®\n\n' +
                  '### ðŸ“Š è¨ºæ–·çµæžœ\n\n' +
                  '- **å¥åº·æª¢æŸ¥**: ' + healthCheckResult + '\n' +
                  '- **è‡ªå‹•ä¿®å¾©**: ' + autoFixResult + '\n\n' +
                  '---\n' +
                  'âš ï¸ è«‹å„˜å¿«è™•ç†æ­¤å•é¡Œ\n' +
                  '*ç”± Self-Healing System è‡ªå‹•ç”Ÿæˆ*';
              }

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: labels
              });
            }

      - name: ðŸ“ˆ Update dashboard
        run: |
          echo "## ðŸ”„ Self-Healing System Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### åŸ·è¡Œçµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| éšŽæ®µ | ç‹€æ…‹ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| å¥åº·æª¢æŸ¥ | ${{ needs.health-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| è‡ªå‹•ä¿®å¾© | ${{ needs.auto-fix.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| è‡ªå‹•é‡è©¦ | ${{ needs.auto-retry.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.health-check.outputs.needs_healing }}" = "true" ]; then
            echo "### ðŸ”§ ç³»çµ±ç‹€æ…‹" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **éœ€è¦ä¿®å¾©**: æ˜¯" >> $GITHUB_STEP_SUMMARY
            echo "- **å¤±æ•—æµç¨‹**: ${{ needs.health-check.outputs.failed_workflow }}" >> $GITHUB_STEP_SUMMARY
            echo "- **ä¿®å¾©æ‡‰ç”¨**: ${{ needs.auto-fix.outputs.fix_applied }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **ç³»çµ±é‹è¡Œæ­£å¸¸**" >> $GITHUB_STEP_SUMMARY
          fi
