name: üöÄ Build, Test & Deploy

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:  # ÂÖÅË®±ÊâãÂãïËß∏Áôº

env:
  RUBY_VERSION: 3.1
  NODE_VERSION: 18

jobs:
  # Job 1: ÊßãÂª∫ËàáÊ∏¨Ë©¶
  build-and-test:
    name: üî® Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ÂÆåÊï¥Ê≠∑Âè≤ÔºåÁî®ÊñºÂàÜÊûê

      - name: üíé Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: üìö Install dependencies
        run: |
          gem install bundler
          bundle install
          npm install -g htmlhint html-validator-cli broken-link-checker

      - name: üî® Build Jekyll site
        run: |
          bundle exec jekyll build --verbose
        env:
          JEKYLL_ENV: production

      - name: üìä Generate build report
        run: |
          echo "## üî® Build Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Build time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Total files**: $(find _site -type f | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- **Total size**: $(du -sh _site | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "- **HTML pages**: $(find _site -name '*.html' | wc -l)" >> $GITHUB_STEP_SUMMARY

      - name: ‚úÖ Validate HTML
        continue-on-error: true
        run: |
          htmlhint _site/**/*.html > htmlhint-report.txt || true
          cat htmlhint-report.txt

      - name: üîó Check internal links
        continue-on-error: true
        run: |
          # ÂÆâË£ù Python Ê∏¨Ë©¶Â∑•ÂÖ∑
          pip install -r _tests/requirements.txt
          python _tests/test_links.py

      - name: üìù Check content quality
        continue-on-error: true
        run: |
          python _tests/test_content.py

      - name: üéØ SEO validation
        continue-on-error: true
        run: |
          python _tests/test_seo.py

      - name: ‚ö° Performance test
        continue-on-error: true
        run: |
          python _tests/test_performance.py

      - name: üìã Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: |
            htmlhint-report.txt
            _tests/reports/

      - name: üì¶ Upload site artifact
        uses: actions/upload-artifact@v4
        with:
          name: site-build
          path: _site/
          retention-days: 7

  # Job 2: ÈÉ®ÁΩ≤Âà∞ VMÔºàÂèØÈÅ∏Ôºâ
  deploy:
    name: üöÄ Deploy to VM
    needs: build-and-test
    runs-on: ubuntu-latest
    # Âè™ÊúâÂú®ÈÖçÁΩÆ‰∫Ü VM secrets ‰∏îÊé®ÈÄÅÂà∞ main ÊôÇÊâçÂü∑Ë°å
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') &&
      secrets.VM_SSH_KEY != '' &&
      secrets.VM_HOST != ''

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: site-build
          path: _site/

      - name: üîë Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VM_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts

      - name: üöÄ Deploy to VM
        run: |
          # ÂâµÂª∫ÂÇô‰ªΩ
          ssh -i ~/.ssh/deploy_key ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
            "cd ${{ secrets.VM_DEPLOY_PATH }} && \
             if [ -d 'current' ]; then \
               cp -r current backup-$(date +%Y%m%d-%H%M%S); \
             fi"

          # ÂêåÊ≠•Êñ∞Êñá‰ª∂
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key" \
            _site/ \
            ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}:${{ secrets.VM_DEPLOY_PATH }}/current/

          # ÈáçÂïüÊúçÂãôÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
          ssh -i ~/.ssh/deploy_key ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
            "sudo systemctl reload nginx || true"

      - name: üè• Health check
        run: |
          # Á≠âÂæÖÊúçÂãôÂïüÂãï
          sleep 5

          # Ê™¢Êü•Á∂≤Á´ôÊòØÂê¶ÂèØË®™Âïè
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.VM_HOST }})

          if [ $HTTP_CODE -eq 200 ]; then
            echo "‚úÖ Health check passed! Site is responding with HTTP $HTTP_CODE"
          else
            echo "‚ùå Health check failed! Site responding with HTTP $HTTP_CODE"
            exit 1
          fi

      - name: üîô Rollback on failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed, rolling back..."
          ssh -i ~/.ssh/deploy_key ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
            "cd ${{ secrets.VM_DEPLOY_PATH }} && \
             LATEST_BACKUP=\$(ls -t backup-* | head -1) && \
             if [ -n \"\$LATEST_BACKUP\" ]; then \
               rm -rf current; \
               cp -r \$LATEST_BACKUP current; \
               sudo systemctl reload nginx; \
             fi"

      - name: üìä Deployment summary
        if: always()
        run: |
          echo "## üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed to**: ${{ secrets.VM_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deploy time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # Job 3: ÈÉ®ÁΩ≤ÂæåÊ∏¨Ë©¶ÔºàÂÉÖÁï∂ VM ÈÉ®ÁΩ≤ÊàêÂäüÊôÇÔºâ
  post-deployment-test:
    name: üß™ Post-Deployment Tests
    needs: deploy
    runs-on: ubuntu-latest
    if: success() && needs.deploy.result == 'success'

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîó Test deployed site
        run: |
          pip install requests beautifulsoup4 selenium
          python _tests/test_deployed_site.py http://${{ secrets.VM_HOST }}

      - name: ‚ö° Performance benchmark
        run: |
          # ‰ΩøÁî® Lighthouse ÊàñÂÖ∂‰ªñÂ∑•ÂÖ∑Ê∏¨Ë©¶ÊÄßËÉΩ
          npm install -g lighthouse
          lighthouse http://${{ secrets.VM_HOST }} \
            --output=json \
            --output-path=./lighthouse-report.json \
            --chrome-flags="--headless"

      - name: üìä Upload performance report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: lighthouse-report.json

  # Job 4: ÈÄöÁü•ÔºàÂèØÈÅ∏Ôºâ
  notify:
    name: üì¢ Notify
    needs: [build-and-test, deploy, post-deployment-test]
    runs-on: ubuntu-latest
    # Á∏ΩÊòØÂü∑Ë°åÔºå‰ΩÜÂè™Âú®ÊúâÈúÄË¶ÅÊôÇÊâçÁôºÈÄÅÈÄöÁü•
    if: always()

    steps:
      - name: üìä Create summary
        run: |
          echo "## üìä Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Build**: ${{ needs.build-and-test.result }}" >> $GITHUB_STEP_SUMMARY

          # Âè™ÊúâÂú® VM ÈÉ®ÁΩ≤ÊúâÂü∑Ë°åÊôÇÊâçÈ°ØÁ§∫
          if [ "${{ needs.deploy.result }}" != "skipped" ]; then
            echo "- **Deploy**: ${{ needs.deploy.result }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Tests**: ${{ needs.post-deployment-test.result }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Deploy**: Skipped (VM not configured)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: üí¨ Slack notification
        if: env.SLACK_WEBHOOK != '' && needs.deploy.result != 'skipped'
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          STATUS="${{ needs.deploy.result }}"
          if [ "$STATUS" = "success" ]; then
            COLOR="good"
            EMOJI="‚úÖ"
            MESSAGE="Deployment successful"
          else
            COLOR="danger"
            EMOJI="‚ùå"
            MESSAGE="Deployment failed"
          fi

          curl -X POST $SLACK_WEBHOOK \
            -H 'Content-Type: application/json' \
            -d "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"$EMOJI $MESSAGE\",
                \"text\": \"Commit: ${{ github.sha }}\nBy: ${{ github.actor }}\"
              }]
            }"
