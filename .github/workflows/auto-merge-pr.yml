name: ğŸ¤ Auto Merge PR

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to merge'
        required: true

# è¨­å®šå¿…è¦çš„æ¬Šé™
permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    name: ğŸ¤– Auto Merge
    runs-on: ubuntu-latest
    # åªè‡ªå‹•åˆä½µç”± bot å‰µå»ºçš„ PR
    if: |
      github.actor == 'github-actions[bot]' ||
      contains(github.event.pull_request.title, 'ğŸ”§ è‡ªå‹•ä¿®å¾©') ||
      contains(github.event.pull_request.title, 'ğŸ¤– è‡ªå‹•ç”Ÿæˆ') ||
      contains(github.event.pull_request.labels.*.name, 'auto-fix') ||
      contains(github.event.pull_request.labels.*.name, 'automated')

    steps:
      - name: ğŸ“¥ Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: ğŸ’ Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.1
          bundler-cache: true

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install -r _tests/requirements.txt
          bundle install

      - name: ğŸ”¨ Build site
        id: build
        run: |
          bundle exec jekyll build --verbose
          echo "build_status=success" >> $GITHUB_OUTPUT
        env:
          JEKYLL_ENV: production

      - name: âœ… Run all tests
        id: test
        continue-on-error: true
        run: |
          echo "ğŸ§ª é‹è¡Œæ‰€æœ‰æ¸¬è©¦..."

          FAILED=0

          # æ¸¬è©¦ 1: é€£çµæª¢æŸ¥
          if python _tests/test_links.py; then
            echo "âœ… é€£çµæ¸¬è©¦é€šé"
          else
            echo "âŒ é€£çµæ¸¬è©¦å¤±æ•—"
            FAILED=$((FAILED + 1))
          fi

          # æ¸¬è©¦ 2: å…§å®¹å“è³ª
          if python _tests/test_content.py; then
            echo "âœ… å…§å®¹æ¸¬è©¦é€šé"
          else
            echo "âŒ å…§å®¹æ¸¬è©¦å¤±æ•—"
            FAILED=$((FAILED + 1))
          fi

          # æ¸¬è©¦ 3: SEO æª¢æŸ¥
          if python _tests/test_seo.py; then
            echo "âœ… SEO æ¸¬è©¦é€šé"
          else
            echo "âŒ SEO æ¸¬è©¦å¤±æ•—"
            FAILED=$((FAILED + 1))
          fi

          echo "failed_tests=$FAILED" >> $GITHUB_OUTPUT

          if [ $FAILED -eq 0 ]; then
            echo "test_status=success" >> $GITHUB_OUTPUT
            echo "âœ… æ‰€æœ‰æ¸¬è©¦é€šé"
            exit 0
          else
            echo "test_status=failed" >> $GITHUB_OUTPUT
            echo "âŒ æœ‰ $FAILED å€‹æ¸¬è©¦å¤±æ•—"
            exit 1
          fi

      - name: ğŸ“Š Test summary
        if: always()
        run: |
          echo "## ğŸ§ª æ¸¬è©¦çµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **æ§‹å»º**: ${{ steps.build.outputs.build_status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ¸¬è©¦**: ${{ steps.test.outputs.test_status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å¤±æ•—æ•¸**: ${{ steps.test.outputs.failed_tests }}" >> $GITHUB_STEP_SUMMARY

      - name: âœ… Approve PR
        if: steps.test.outputs.test_status == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;

            // æ·»åŠ æ‰¹å‡†
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              event: 'APPROVE',
              body: 'âœ… è‡ªå‹•å¯©æ ¸é€šé\n\næ‰€æœ‰æ¸¬è©¦å‡å·²é€šéï¼Œå¯ä»¥å®‰å…¨åˆä½µã€‚\n\n---\n*ç”± Auto Merge Bot è‡ªå‹•å¯©æ ¸*'
            });

      - name: ğŸš€ Auto merge PR
        if: steps.test.outputs.test_status == 'success'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;

            try {
              // å˜—è©¦åˆä½µ PR
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash',
                commit_title: 'ğŸ¤– Auto-merge: ' + context.payload.pull_request.title,
                commit_message: 'Automatically merged after passing all tests.\n\nRun ID: ' + context.runId
              });

              console.log('âœ… PR #' + prNumber + ' å·²æˆåŠŸåˆä½µ');

              // æ·»åŠ è©•è«–
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: 'ğŸ‰ PR å·²è‡ªå‹•åˆä½µï¼\n\nâœ… æ‰€æœ‰æ¸¬è©¦é€šé\nâœ… è‡ªå‹•å¯©æ ¸é€šé\nâœ… å·²åˆä½µè‡³ main åˆ†æ”¯\n\n---\n*ç”± Auto Merge System è‡ªå‹•åŸ·è¡Œ*'
              });

            } catch (error) {
              console.error('âŒ åˆä½µå¤±æ•—:', error.message);

              // æ·»åŠ è©•è«–èªªæ˜å¤±æ•—åŸå› 
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: 'âš ï¸ è‡ªå‹•åˆä½µå¤±æ•—\n\néŒ¯èª¤: ' + error.message + '\n\nè«‹æ‰‹å‹•åˆä½µæ­¤ PRã€‚'
              });

              throw error;
            }

      - name: âŒ Comment on failed tests
        if: steps.test.outputs.test_status == 'failed'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const failedCount = '${{ steps.test.outputs.failed_tests }}';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: 'âŒ è‡ªå‹•åˆä½µå¤±æ•—\n\n' +
                'æœ‰ ' + failedCount + ' å€‹æ¸¬è©¦å¤±æ•—ã€‚è«‹æª¢æŸ¥ä¸¦ä¿®å¾©å•é¡Œå¾Œå†æ¬¡æäº¤ã€‚\n\n' +
                '### ğŸ” æª¢æŸ¥é …ç›®\n\n' +
                '- æŸ¥çœ‹ Actions æ—¥èªŒäº†è§£è©³ç´°éŒ¯èª¤\n' +
                '- ç¢ºèªæ‰€æœ‰é€£çµæœ‰æ•ˆ\n' +
                '- é©—è­‰å…§å®¹å“è³ª\n' +
                '- æª¢æŸ¥ SEO è¨­å®š\n\n' +
                '---\n' +
                '*ç”± Auto Merge System è‡ªå‹•ç”Ÿæˆ*'
            });

      - name: ğŸ”„ Trigger self-healing on failure
        if: steps.test.outputs.test_status == 'failed'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // è§¸ç™¼ self-healing workflow
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'self-healing.yml',
              ref: 'main',
              inputs: {
                force_fix: 'true'
              }
            });

            console.log('ğŸ”„ å·²è§¸ç™¼ Self-Healing System');
