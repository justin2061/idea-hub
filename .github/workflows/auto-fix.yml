name: ğŸ”§ Auto Fix Issues

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨ 2 é»é‹è¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_run:
    workflows: ["ğŸš€ Build, Test & Deploy"]
    types:
      - completed

jobs:
  detect-and-fix:
    name: ğŸ” Detect & Fix Issues
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' || github.event_name != 'workflow_run' }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ’ Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.1
          bundler-cache: true

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install dependencies
        run: |
          bundle install
          pip install -r _tests/requirements.txt

      - name: ğŸ”¨ Build site
        run: |
          bundle exec jekyll build
        env:
          JEKYLL_ENV: production

      - name: ğŸ” Scan for issues
        id: scan
        run: |
          python _tests/auto_fixer.py scan > scan_report.json
          cat scan_report.json

          # æª¢æŸ¥æ˜¯å¦æœ‰å•é¡Œ
          ISSUES_COUNT=$(jq '.total_issues' scan_report.json)
          echo "issues_count=$ISSUES_COUNT" >> $GITHUB_OUTPUT

      - name: ğŸ”§ Auto fix issues
        if: steps.scan.outputs.issues_count > 0
        id: fix
        run: |
          python _tests/auto_fixer.py fix > fix_report.json
          cat fix_report.json

          FIXED_COUNT=$(jq '.fixed_count' fix_report.json)
          echo "fixed_count=$FIXED_COUNT" >> $GITHUB_OUTPUT

      - name: âœ… Verify fixes
        if: steps.fix.outputs.fixed_count > 0
        run: |
          bundle exec jekyll build
          python _tests/test_runner.py

      - name: ğŸ“ Create PR with fixes
        if: steps.fix.outputs.fixed_count > 0
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ğŸ”§ è‡ªå‹•ä¿®å¾©ï¼š${{ steps.fix.outputs.fixed_count }} å€‹å•é¡Œ

            ç”± Auto Fix å·¥ä½œæµè‡ªå‹•ç”Ÿæˆ
          branch: auto-fix/issues-${{ github.run_number }}
          delete-branch: true
          title: 'ğŸ”§ è‡ªå‹•ä¿®å¾©ï¼š${{ steps.fix.outputs.fixed_count }} å€‹å•é¡Œ'
          body: |
            ## ğŸ¤– è‡ªå‹•ä¿®å¾©å ±å‘Š

            æ­¤ PR ç”±è‡ªå‹•åŒ–å·¥ä½œæµç”Ÿæˆï¼Œä¿®å¾©äº†ä»¥ä¸‹å•é¡Œï¼š

            ### ğŸ“Š ä¿®å¾©çµ±è¨ˆ

            ```json
            ${{ steps.fix.outputs.fix_report }}
            ```

            ### âœ… å·²ä¿®å¾©çš„å•é¡Œ

            - æ­»é€£çµä¿®å¾©
            - åœ–ç‰‡è·¯å¾‘ä¿®æ­£
            - Markdown æ ¼å¼åŒ–
            - SEO å„ªåŒ–

            ### ğŸ” é©—è­‰çµæœ

            æ‰€æœ‰ä¿®å¾©å·²é€šéè‡ªå‹•åŒ–æ¸¬è©¦é©—è­‰ã€‚

            ---
            *æ­¤ PR ç”± GitHub Actions è‡ªå‹•å‰µå»º*
          labels: |
            auto-fix
            automated
          reviewers: ${{ github.actor }}

      - name: ğŸ“Š Create issue for unfixable problems
        if: steps.scan.outputs.issues_count > steps.fix.outputs.fixed_count
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const scanReport = JSON.parse(fs.readFileSync('scan_report.json', 'utf8'));
            const fixReport = JSON.parse(fs.readFileSync('fix_report.json', 'utf8'));

            const unfixedIssues = scanReport.issues.filter(issue =>
              !fixReport.fixed_issues.some(fixed => fixed.id === issue.id)
            );

            if (unfixedIssues.length > 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `âš ï¸ ç™¼ç¾ ${unfixedIssues.length} å€‹éœ€è¦äººå·¥è™•ç†çš„å•é¡Œ`,
                body: `## ğŸ” å•é¡Œå ±å‘Š

ä»¥ä¸‹å•é¡Œç„¡æ³•è‡ªå‹•ä¿®å¾©ï¼Œéœ€è¦äººå·¥è™•ç†ï¼š

${unfixedIssues.map((issue, i) => `
### ${i + 1}. ${issue.type}

- **æª”æ¡ˆ**: \`${issue.file}\`
- **ä½ç½®**: ç¬¬ ${issue.line} è¡Œ
- **æè¿°**: ${issue.description}
- **å»ºè­°**: ${issue.suggestion}
`).join('\n')}

---
*ç”±è‡ªå‹•åŒ–å·¥ä½œæµç”Ÿæˆæ–¼ ${new Date().toISOString()}*
`,
                labels: ['bug', 'needs-review', 'automated']
              });
            }

      - name: ğŸ“Š Summary
        if: always()
        run: |
          echo "## ğŸ”§ Auto Fix Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Total issues found**: ${{ steps.scan.outputs.issues_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Auto-fixed**: ${{ steps.fix.outputs.fixed_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Requires manual fix**: $((${{ steps.scan.outputs.issues_count }} - ${{ steps.fix.outputs.fixed_count }}))" >> $GITHUB_STEP_SUMMARY

  performance-optimization:
    name: âš¡ Performance Optimization
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ–¼ï¸ Optimize images
        run: |
          # å®‰è£åœ–ç‰‡å„ªåŒ–å·¥å…·
          sudo apt-get update
          sudo apt-get install -y optipng jpegoptim

          # å„ªåŒ–åœ–ç‰‡
          find assets/images -name "*.png" -exec optipng -o2 {} \;
          find assets/images -name "*.jpg" -exec jpegoptim --max=85 {} \;

      - name: ğŸ“¦ Check for large files
        run: |
          # æª¢æŸ¥å¤§æ–‡ä»¶ï¼ˆ> 1MBï¼‰
          find . -type f -size +1M -not -path "./.git/*" > large_files.txt

          if [ -s large_files.txt ]; then
            echo "âš ï¸ ç™¼ç¾å¤§æ–‡ä»¶ï¼š" >> $GITHUB_STEP_SUMMARY
            cat large_files.txt >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ“ Create optimization PR
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: 'âš¡ è‡ªå‹•å„ªåŒ–ï¼šåœ–ç‰‡å£“ç¸®å’Œæ€§èƒ½æ”¹é€²'
          branch: auto-optimize/performance-${{ github.run_number }}
          title: 'âš¡ æ€§èƒ½å„ªåŒ–ï¼šåœ–ç‰‡å£“ç¸®'
          body: |
            ## âš¡ æ€§èƒ½å„ªåŒ–å ±å‘Š

            æ­¤ PR åŒ…å«ä»¥ä¸‹å„ªåŒ–ï¼š

            - ğŸ–¼ï¸ åœ–ç‰‡å£“ç¸®ï¼ˆPNG, JPGï¼‰
            - ğŸ“¦ å¤§æ–‡ä»¶æª¢æ¸¬å’Œå»ºè­°

            ---
            *è‡ªå‹•ç”Ÿæˆ*
          labels: |
            performance
            automated
