name: ğŸ¤– Fully Auto Generate & Publish

on:
  # å®šæœŸè‡ªå‹•é‹è¡Œ
  schedule:
    # æ¯é€±ä¸€ã€ä¸‰ã€äº”æ—©ä¸Š 9:00 (å°ç£æ™‚é–“)
    - cron: '0 1 * * 1,3,5'  # UTC 1:00 = å°ç£ 9:00

  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      categories:
        description: 'åˆ†é¡ï¼ˆç”¨ç©ºæ ¼åˆ†éš”ï¼Œæˆ– allï¼‰'
        required: false
        default: 'all'
      count:
        description: 'æ¯åˆ†é¡æ–‡ç« æ•¸'
        required: false
        default: '1'
      skip_validation:
        description: 'è·³éå“è³ªé©—è­‰ï¼ˆä¸å»ºè­°ï¼‰'
        type: boolean
        required: false
        default: false

env:
  PYTHON_VERSION: '3.11'
  MIN_WORDS: 1500  # æœ€å°‘å­—æ•¸
  MIN_QUALITY_SCORE: 7  # æœ€ä½å“è³ªåˆ†æ•¸ (0-10)

jobs:
  auto-generate-and-publish:
    name: ğŸš€ Auto Generate & Publish
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ”§ Configure Git
        run: |
          git config user.name "Auto Content Bot"
          git config user.email "bot@github-actions"

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install anthropic requests pyyaml beautifulsoup4

      - name: ğŸ“Š Get current stats
        id: before_stats
        run: |
          BEFORE_COUNT=$(ls _posts/*.md 2>/dev/null | wc -l || echo "0")
          echo "before_count=$BEFORE_COUNT" >> $GITHUB_OUTPUT

      - name: ğŸ¤– Generate articles
        id: generate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
        run: |
          echo "ğŸ¤– é–‹å§‹è‡ªå‹•ç”Ÿæˆå…§å®¹..."

          # è¨­å®šåƒæ•¸
          CATEGORIES="${{ github.event.inputs.categories || 'all' }}"
          COUNT="${{ github.event.inputs.count || '1' }}"

          echo "ğŸ“‹ é…ç½®ï¼š"
          echo "  - åˆ†é¡: $CATEGORIES"
          echo "  - æ¯åˆ†é¡: $COUNT ç¯‡"
          echo ""

          # é‹è¡Œç”Ÿæˆå™¨
          cd _tools
          python auto_content_generator.py \
            --categories $CATEGORIES \
            --count $COUNT \
            2>&1 | tee ../generation.log

          cd ..

          # è¨ˆç®—ç”Ÿæˆçš„æ–‡ç« æ•¸
          GENERATED_COUNT=$(ls -1 _posts/$(date +%Y-%m-%d)-*.md 2>/dev/null | wc -l || echo "0")
          echo "generated_count=$GENERATED_COUNT" >> $GITHUB_OUTPUT

          if [ "$GENERATED_COUNT" -eq 0 ]; then
            echo "âš ï¸ æ²’æœ‰ç”Ÿæˆä»»ä½•æ–‡ç« "
            exit 1
          fi

          echo "âœ… æˆåŠŸç”Ÿæˆ $GENERATED_COUNT ç¯‡æ–‡ç« "

      - name: ğŸ” Quality validation
        id: validate
        if: steps.generate.outputs.generated_count > 0 && github.event.inputs.skip_validation != 'true'
        run: |
          echo "ğŸ” å“è³ªé©—è­‰..."

          FAILED=0
          WARNINGS=0

          for file in _posts/$(date +%Y-%m-%d)-*.md; do
            if [ ! -f "$file" ]; then
              continue
            fi

            BASENAME=$(basename "$file")
            echo "ğŸ“„ æª¢æŸ¥: $BASENAME"

            # æª¢æŸ¥ 1: Front matter
            if ! head -1 "$file" | grep -q "^---"; then
              echo "  âŒ ç¼ºå°‘ front matter"
              FAILED=$((FAILED + 1))
              continue
            fi

            # æª¢æŸ¥ 2: å¿…è¦æ¬„ä½
            if ! grep -q "^title:" "$file"; then
              echo "  âŒ ç¼ºå°‘ title"
              FAILED=$((FAILED + 1))
              continue
            fi

            if ! grep -q "^date:" "$file"; then
              echo "  âŒ ç¼ºå°‘ date"
              FAILED=$((FAILED + 1))
              continue
            fi

            # æª¢æŸ¥ 3: å­—æ•¸
            WORDS=$(wc -w < "$file")
            if [ "$WORDS" -lt "$MIN_WORDS" ]; then
              echo "  âš ï¸  å­—æ•¸ä¸è¶³: $WORDS < $MIN_WORDS"
              WARNINGS=$((WARNINGS + 1))
            fi

            # æª¢æŸ¥ 4: å…§å®¹çµæ§‹
            if ! grep -q "^##" "$file"; then
              echo "  âš ï¸  ç¼ºå°‘ç« ç¯€æ¨™é¡Œ"
              WARNINGS=$((WARNINGS + 1))
            fi

            echo "  âœ… é©—è­‰é€šé ($WORDS å­—)"
          done

          echo "validation_failed=$FAILED" >> $GITHUB_OUTPUT
          echo "validation_warnings=$WARNINGS" >> $GITHUB_OUTPUT

          if [ "$FAILED" -gt 0 ]; then
            echo "âŒ æœ‰ $FAILED ç¯‡æ–‡ç« é©—è­‰å¤±æ•—"
            exit 1
          fi

          if [ "$WARNINGS" -gt 0 ]; then
            echo "âš ï¸  æœ‰ $WARNINGS å€‹è­¦å‘Šï¼Œä½†ç¹¼çºŒç™¼å¸ƒ"
          else
            echo "âœ… æ‰€æœ‰æ–‡ç« é©—è­‰é€šé"
          fi

      - name: ğŸ“ Generate article list
        if: steps.generate.outputs.generated_count > 0
        id: article_list
        run: |
          echo "## ğŸ“ ä»Šæ—¥ç”Ÿæˆçš„æ–‡ç« " > article_list.md
          echo "" >> article_list.md

          for file in _posts/$(date +%Y-%m-%d)-*.md; do
            if [ -f "$file" ]; then
              TITLE=$(grep "^title:" "$file" | sed 's/title: *"\(.*\)"/\1/')
              CATEGORY=$(grep "^categories:" -A 1 "$file" | tail -1 | sed 's/.*- //')
              WORDS=$(wc -w < "$file")
              echo "- **[$CATEGORY]** $TITLE ($WORDS å­—)" >> article_list.md
            fi
          done

          # ä¿å­˜ç‚º output
          ARTICLE_LIST=$(cat article_list.md)
          echo "articles<<EOF" >> $GITHUB_OUTPUT
          echo "$ARTICLE_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸš€ Auto commit and push
        if: steps.generate.outputs.generated_count > 0
        id: commit
        run: |
          # æ·»åŠ ç”Ÿæˆçš„æ–‡ç« 
          git add _posts/$(date +%Y-%m-%d)-*.md

          # ç”Ÿæˆ commit è¨Šæ¯
          cat > commit_message.txt <<EOF
          ğŸ¤– è‡ªå‹•ç”Ÿæˆ ${{ steps.generate.outputs.generated_count }} ç¯‡æ–‡ç« 

          ğŸ“… ç”Ÿæˆæ™‚é–“ï¼š$(date '+%Y-%m-%d %H:%M:%S')
          ğŸ·ï¸  åˆ†é¡ï¼š${{ github.event.inputs.categories || 'all' }}

          $(cat article_list.md)

          ---
          ç”±è‡ªå‹•å…§å®¹ç”Ÿæˆç³»çµ±å‰µå»º
          Run ID: ${{ github.run_id }}
          EOF

          git commit -F commit_message.txt

          # æ¨é€åˆ°ç•¶å‰åˆ†æ”¯
          CURRENT_BRANCH=$(git branch --show-current)
          echo "branch=$CURRENT_BRANCH" >> $GITHUB_OUTPUT

          # å¦‚æœæ˜¯ main/master åˆ†æ”¯ï¼Œç›´æ¥æ¨é€
          # å¦‚æœæ˜¯å…¶ä»–åˆ†æ”¯ï¼Œæ¨é€åˆ°è©²åˆ†æ”¯
          git push origin $CURRENT_BRANCH

          echo "âœ… æˆåŠŸæ¨é€åˆ° $CURRENT_BRANCH"

      - name: ğŸ“Š Generate statistics
        if: steps.generate.outputs.generated_count > 0
        id: stats
        run: |
          AFTER_COUNT=$(ls _posts/*.md 2>/dev/null | wc -l)
          TOTAL_WORDS=0

          for file in _posts/$(date +%Y-%m-%d)-*.md; do
            if [ -f "$file" ]; then
              WORDS=$(wc -w < "$file")
              TOTAL_WORDS=$((TOTAL_WORDS + WORDS))
            fi
          done

          AVG_WORDS=$((TOTAL_WORDS / ${{ steps.generate.outputs.generated_count }}))

          echo "## ğŸ“Š çµ±è¨ˆè³‡è¨Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“ **æœ¬æ¬¡ç”Ÿæˆ**: ${{ steps.generate.outputs.generated_count }} ç¯‡" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“š **ç¸½æ–‡ç« æ•¸**: $AFTER_COUNT ç¯‡" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“– **ç¸½å­—æ•¸**: $(printf "%'d" $TOTAL_WORDS) å­—" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“ **å¹³å‡å­—æ•¸**: $(printf "%'d" $AVG_WORDS) å­—/ç¯‡" >> $GITHUB_STEP_SUMMARY
          echo "- â° **ç”Ÿæˆæ™‚é–“**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸŒ¿ **åˆ†æ”¯**: ${{ steps.commit.outputs.branch }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.validate.outputs.validation_warnings }}" -gt 0 ]; then
            echo "- âš ï¸  **è­¦å‘Š**: ${{ steps.validate.outputs.validation_warnings }} å€‹" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ“‹ Create daily report issue
        if: steps.generate.outputs.generated_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const articleList = `${{ steps.article_list.outputs.articles }}`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ“Š è‡ªå‹•ç”Ÿæˆå ±å‘Š - ${date}`,
              body: `## ğŸ¤– è‡ªå‹•å…§å®¹ç”Ÿæˆå ±å‘Š

**ç”Ÿæˆæ™‚é–“**: ${new Date().toLocaleString('zh-TW')}
**æ–‡ç« æ•¸é‡**: ${{ steps.generate.outputs.generated_count }} ç¯‡

${articleList}

### ğŸ“Š è©³ç´°çµ±è¨ˆ

- **å“è³ªé©—è­‰**: ${{ steps.validate.outputs.validation_failed || 0 }} å€‹éŒ¯èª¤, ${{ steps.validate.outputs.validation_warnings || 0 }} å€‹è­¦å‘Š
- **åˆ†æ”¯**: ${{ steps.commit.outputs.branch }}
- **Commit**: \`${context.sha.substring(0, 7)}\`
- **Workflow Run**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

### ğŸ”— å¿«é€Ÿé€£çµ

- [æŸ¥çœ‹æ‰€æœ‰æ–‡ç« ](/${{ github.repository }}/tree/main/_posts)
- [æŸ¥çœ‹ç¶²ç«™](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }})

---
*æ­¤å ±å‘Šç”±è‡ªå‹•å…§å®¹ç”Ÿæˆç³»çµ±å‰µå»º*
`,
              labels: ['auto-generated', 'daily-report']
            });

      - name: ğŸ’¬ Slack notification
        if: always() && env.SLACK_WEBHOOK != ''
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            COLOR="good"
            EMOJI="âœ…"
            MESSAGE="æˆåŠŸç”Ÿæˆ ${{ steps.generate.outputs.generated_count }} ç¯‡æ–‡ç« "
          else
            COLOR="danger"
            EMOJI="âŒ"
            MESSAGE="ç”Ÿæˆå¤±æ•—ï¼Œè«‹æŸ¥çœ‹æ—¥èªŒ"
          fi

          curl -X POST $SLACK_WEBHOOK \
            -H 'Content-Type: application/json' \
            -d "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"$EMOJI è‡ªå‹•å…§å®¹ç”Ÿæˆ - $STATUS\",
                \"text\": \"$MESSAGE\",
                \"fields\": [
                  {\"title\": \"æ™‚é–“\", \"value\": \"$(date '+%Y-%m-%d %H:%M')\", \"short\": true},
                  {\"title\": \"åˆ†æ”¯\", \"value\": \"${{ steps.commit.outputs.branch || 'N/A' }}\", \"short\": true}
                ]
              }]
            }"

      - name: ğŸ“Š Final summary
        if: always()
        run: |
          echo "## ğŸ¯ åŸ·è¡Œæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.generate.outputs.generated_count }}" -gt 0 ]; then
            echo "âœ… **ç‹€æ…‹**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.article_list.outputs.articles }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸš€ **å·²è‡ªå‹•ç™¼å¸ƒåˆ°**: ${{ steps.commit.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
            echo "ğŸŒ **ç¶²ç«™å°‡åœ¨ 2-5 åˆ†é˜å¾Œæ›´æ–°**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ç‹€æ…‹**: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ’¡ **å»ºè­°**: æª¢æŸ¥ API Key è¨­å®šæˆ–æŸ¥çœ‹è©³ç´°æ—¥èªŒ" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ§¹ Cleanup on failure
        if: failure()
        run: |
          # å¦‚æœå¤±æ•—ï¼Œå›æ»¾æœªå®Œæˆçš„æ›´æ”¹
          git reset --hard HEAD
          echo "âš ï¸ å·²å›æ»¾æ‰€æœ‰æ›´æ”¹"

  # éƒ¨ç½²åˆ° GitHub Pagesï¼ˆå¦‚æœåœ¨ main åˆ†æ”¯ï¼‰
  deploy-to-pages:
    name: ğŸŒ Deploy to GitHub Pages
    needs: auto-generate-and-publish
    if: success() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    uses: ./.github/workflows/jekyll.yml
    secrets: inherit
