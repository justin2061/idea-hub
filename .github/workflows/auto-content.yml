name: ğŸ¤– Auto Generate Content

on:
  # å®šæœŸé‹è¡Œï¼ˆæ¯é€±ä¸€æ—©ä¸Š 9 é»ï¼‰
  schedule:
    - cron: '0 1 * * 1'  # UTC æ™‚é–“é€±ä¸€ 1:00 = å°ç£æ™‚é–“ 9:00

  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      categories:
        description: 'è¦ç”Ÿæˆçš„åˆ†é¡ï¼ˆç”¨ç©ºæ ¼åˆ†éš”ï¼Œæˆ–è¼¸å…¥ allï¼‰'
        required: false
        default: 'all'
      count:
        description: 'æ¯å€‹åˆ†é¡ç”Ÿæˆå¹¾ç¯‡æ–‡ç« '
        required: false
        default: '1'
      auto_publish:
        description: 'æ˜¯å¦è‡ªå‹•ç™¼å¸ƒåˆ° main åˆ†æ”¯'
        type: boolean
        required: false
        default: true

env:
  PYTHON_VERSION: '3.11'

jobs:
  generate-content:
    name: ğŸ“ Generate Articles
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install anthropic requests pyyaml beautifulsoup4

      - name: ğŸ” Search trending topics
        id: search
        run: |
          echo "ğŸ” æœå°‹å„åˆ†é¡çš„ç†±é–€è©±é¡Œ..."
          python _tools/auto_content_generator.py \
            --categories ${{ github.event.inputs.categories || 'all' }} \
            --count 0  # åªæœå°‹ä¸ç”Ÿæˆï¼Œç”¨æ–¼é è¦½
        continue-on-error: true

      - name: ğŸ¤– Generate articles with AI
        id: generate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
        run: |
          echo "ğŸ¤– ä½¿ç”¨ AI ç”Ÿæˆæ–‡ç« ..."

          # è¨­å®šåƒæ•¸
          CATEGORIES="${{ github.event.inputs.categories || 'all' }}"
          COUNT="${{ github.event.inputs.count || '1' }}"

          # é‹è¡Œç”Ÿæˆå™¨
          python _tools/auto_content_generator.py \
            --categories $CATEGORIES \
            --count $COUNT

          # è¨ˆç®—ç”Ÿæˆçš„æ–‡ç« æ•¸
          GENERATED_COUNT=$(ls -1 _posts/$(date +%Y-%m-%d)-*.md 2>/dev/null | wc -l || echo "0")
          echo "generated_count=$GENERATED_COUNT" >> $GITHUB_OUTPUT

          if [ "$GENERATED_COUNT" -eq 0 ]; then
            echo "âš ï¸ æ²’æœ‰ç”Ÿæˆä»»ä½•æ–‡ç« "
            exit 1
          fi

          echo "âœ… æˆåŠŸç”Ÿæˆ $GENERATED_COUNT ç¯‡æ–‡ç« "

      - name: ğŸ“‹ List generated articles
        if: steps.generate.outputs.generated_count > 0
        run: |
          echo "## ğŸ“ ç”Ÿæˆçš„æ–‡ç« " >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for file in _posts/$(date +%Y-%m-%d)-*.md; do
            if [ -f "$file" ]; then
              TITLE=$(grep "^title:" "$file" | sed 's/title: *"\(.*\)"/\1/')
              CATEGORY=$(grep "^categories:" -A 1 "$file" | tail -1 | sed 's/.*- //')
              echo "- **[$CATEGORY]** $TITLE" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: âœ… Validate articles
        if: steps.generate.outputs.generated_count > 0
        run: |
          echo "ğŸ” é©—è­‰æ–‡ç« æ ¼å¼..."

          for file in _posts/$(date +%Y-%m-%d)-*.md; do
            if [ -f "$file" ]; then
              # æª¢æŸ¥ front matter
              if ! head -1 "$file" | grep -q "^---"; then
                echo "âŒ $file ç¼ºå°‘ front matter"
                exit 1
              fi

              # æª¢æŸ¥å¿…è¦æ¬„ä½
              if ! grep -q "^title:" "$file"; then
                echo "âŒ $file ç¼ºå°‘ title"
                exit 1
              fi

              if ! grep -q "^date:" "$file"; then
                echo "âŒ $file ç¼ºå°‘ date"
                exit 1
              fi

              echo "âœ… $(basename $file) æ ¼å¼æ­£ç¢º"
            fi
          done

      - name: ğŸ“Š Generate statistics
        if: steps.generate.outputs.generated_count > 0
        run: |
          echo "## ğŸ“Š çµ±è¨ˆè³‡è¨Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          TOTAL_WORDS=0

          for file in _posts/$(date +%Y-%m-%d)-*.md; do
            if [ -f "$file" ]; then
              WORDS=$(wc -w < "$file")
              TOTAL_WORDS=$((TOTAL_WORDS + WORDS))
            fi
          done

          echo "- **æ–‡ç« æ•¸é‡**: ${{ steps.generate.outputs.generated_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç¸½å­—æ•¸**: $TOTAL_WORDS" >> $GITHUB_STEP_SUMMARY
          echo "- **å¹³å‡å­—æ•¸**: $((TOTAL_WORDS / ${{ steps.generate.outputs.generated_count }}))" >> $GITHUB_STEP_SUMMARY
          echo "- **ç”Ÿæˆæ™‚é–“**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“ Create Pull Request
        if: steps.generate.outputs.generated_count > 0 && github.event.inputs.auto_publish != 'false'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ğŸ¤– è‡ªå‹•ç”Ÿæˆ ${{ steps.generate.outputs.generated_count }} ç¯‡æ–‡ç« 

            åˆ†é¡ï¼š${{ github.event.inputs.categories || 'all' }}
            ç”Ÿæˆæ™‚é–“ï¼š${{ steps.date.outputs.date }}

            ç”±è‡ªå‹•å…§å®¹ç”Ÿæˆç³»çµ±å‰µå»º
          branch: auto-content/${{ github.run_number }}
          delete-branch: true
          title: 'ğŸ¤– è‡ªå‹•ç”Ÿæˆå…§å®¹ï¼š${{ steps.generate.outputs.generated_count }} ç¯‡æ–°æ–‡ç« '
          body: |
            ## ğŸ¤– è‡ªå‹•ç”Ÿæˆçš„å…§å®¹

            æ­¤ PR ç”±è‡ªå‹•å…§å®¹ç”Ÿæˆç³»çµ±å‰µå»ºï¼ŒåŒ…å« ${{ steps.generate.outputs.generated_count }} ç¯‡æ–°æ–‡ç« ã€‚

            ### ğŸ“ ç”Ÿæˆçš„æ–‡ç« 

            ${{ steps.list.outputs.articles }}

            ### âš™ï¸ ç”Ÿæˆé…ç½®

            - **åˆ†é¡**: ${{ github.event.inputs.categories || 'all' }}
            - **æ¯åˆ†é¡æ–‡ç« æ•¸**: ${{ github.event.inputs.count || '1' }}
            - **ç”Ÿæˆæ™‚é–“**: ${{ steps.date.outputs.date }}

            ### âœ… é©—è­‰ç‹€æ…‹

            - [x] Front matter å®Œæ•´
            - [x] å¿…è¦æ¬„ä½å­˜åœ¨
            - [x] æ–‡ç« æ ¼å¼æ­£ç¢º

            ### ğŸ” å¯©æŸ¥å»ºè­°

            1. æª¢æŸ¥æ–‡ç« å…§å®¹è³ªé‡
            2. é©—è­‰äº‹å¯¦æº–ç¢ºæ€§
            3. ç¢ºèªèªæ°£å’Œé¢¨æ ¼
            4. æª¢æŸ¥é€£çµæœ‰æ•ˆæ€§

            ---
            *æ­¤ PR ç”± GitHub Actions è‡ªå‹•å‰µå»º*
          labels: |
            auto-generated
            content
            needs-review

      - name: ğŸ“Š Summary
        if: always()
        run: |
          echo "## ğŸ¯ åŸ·è¡Œæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.generate.outputs.generated_count }}" -gt 0 ]; then
            echo "âœ… **ç‹€æ…‹**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“ **ç”Ÿæˆ**: ${{ steps.generate.outputs.generated_count }} ç¯‡æ–‡ç« " >> $GITHUB_STEP_SUMMARY

            if [ "${{ github.event.inputs.auto_publish }}" != "false" ]; then
              echo "ğŸ“¤ **æ“ä½œ**: å·²å‰µå»º Pull Request" >> $GITHUB_STEP_SUMMARY
            else
              echo "ğŸ“¤ **æ“ä½œ**: æ–‡ç« å·²ä¿å­˜ï¼Œç­‰å¾…æ‰‹å‹•ç™¼å¸ƒ" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ **ç‹€æ…‹**: æ²’æœ‰ç”Ÿæˆæ–‡ç« " >> $GITHUB_STEP_SUMMARY
            echo "ğŸ’¡ **å»ºè­°**: æª¢æŸ¥ API Key è¨­å®šæˆ–æœå°‹æ¢ä»¶" >> $GITHUB_STEP_SUMMARY
          fi

  # å¯é¸ï¼šè‡ªå‹•åˆä½µ PRï¼ˆå¦‚æœä½ ä¿¡ä»» AI ç”Ÿæˆçš„å…§å®¹ï¼‰
  # auto-merge:
  #   name: ğŸ”€ Auto Merge
  #   needs: generate-content
  #   runs-on: ubuntu-latest
  #   if: github.event.inputs.auto_publish == 'true'
  #
  #   steps:
  #     - name: ğŸ”€ Merge Pull Request
  #       uses: pascalgn/automerge-action@v0.15.6
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #         MERGE_LABELS: "auto-generated,!needs-review"
  #         MERGE_METHOD: "squash"
